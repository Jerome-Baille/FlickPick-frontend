@if (displayedItems.length !== 0) {
    <div class="voting-container" [@fadeAnimation]>
        <!-- Page Heading -->
        <div class="voting-header">
            <div class="header-content">
                <h1 class="header-title">
                    Rank Your <span class="highlight">Favorites</span>
                </h1>
                <p class="header-subtitle">
                    Drag movies from the shortlist into your top 3 slots. The group's combined ranking will decide what we watch!
                </p>
            </div>
            <div class="selections-indicator">
                <span class="selections-label">Selections</span>
                <span class="selections-count">{{ rankedItems.length }}<span class="selections-total">/{{ requiredSlots }}</span></span>
            </div>
        </div>

        <!-- Main Interactive Area -->
        <div class="voting-grid">
            <!-- Left Column: The Shortlist (Source) -->
            <div class="shortlist-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <mat-icon>list_alt</mat-icon>
                        The Shortlist
                    </h3>
                    <div class="view-toggle">
                        <button mat-icon-button class="view-button">
                            <mat-icon>grid_view</mat-icon>
                        </button>
                        <button mat-icon-button class="view-button">
                            <mat-icon>view_list</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Movie Grid -->
                <div class="movie-grid" cdkDropList #shortlistDropList="cdkDropList" 
                     [cdkDropListData]="availableItems"
                     [cdkDropListConnectedTo]="[rankingDropList]"
                     (cdkDropListDropped)="onDrop($event)">
                    @for (item of availableItems; track item.tmdbId) {
                        <div class="movie-card" cdkDrag [@cardAnimation]>
                            <div class="movie-poster">
                                <div class="poster-image" 
                                     [style.background-image]="'url(' + (item.posterPath ? TMDB_IMAGE_BASE_URL_300 + item.posterPath : 'assets/images/poster-not-found.png') + ')'">
                                </div>
                                <div class="poster-overlay"></div>
                                @if (item.sumOfRatings) {
                                    <div class="rating-badge">
                                        {{ (item.sumOfRatings / 10).toFixed(1) }}
                                    </div>
                                }
                            </div>
                            <div class="movie-info">
                                <h4 class="movie-title">{{ item.title }}</h4>
                                <div class="movie-meta">
                                    @if (item.releaseDate) {
                                        <span>{{ item.releaseDate | date:'yyyy' }}</span>
                                        <span class="meta-dot"></span>
                                    }
                                    <span>{{ item.mediaType === 'movie' ? 'Movie' : 'TV Show' }}</span>
                                </div>
                            </div>
                            <!-- Hover Action Overlay -->
                            <div class="drag-overlay">
                                <span class="drag-cta">
                                    <mat-icon>drag_pan</mat-icon> Drag to Rank
                                </span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Right Column: Ranking Slots (Target) -->
            <div class="ranking-section">
                <div class="ranking-panel glass-panel">
                    <div class="ranking-header">
                        <h3 class="ranking-title">
                            <mat-icon class="trophy-icon">emoji_events</mat-icon>
                            Your Top Picks
                        </h3>
                        <span class="slots-badge">{{ requiredSlots }} slots required</span>
                    </div>

                    <div class="ranking-slots" cdkDropList #rankingDropList="cdkDropList"
                         [cdkDropListData]="rankedItems"
                         [cdkDropListConnectedTo]="[shortlistDropList]"
                         (cdkDropListDropped)="onDrop($event)">
                        @for (slot of rankingSlots; track slot.rank; let i = $index) {
                            <div class="ranking-slot" [class.filled]="slot.item" [class.rank-one]="slot.rank === 1">
                                <div class="rank-number">{{ slot.rank }}</div>
                                @if (slot.item) {
                                    <!-- Filled State -->
                                    <div class="ranked-card" cdkDrag>
                                        <div class="drag-handle" cdkDragHandle>
                                            <mat-icon>drag_indicator</mat-icon>
                                        </div>
                                        <div class="ranked-poster" 
                                             [style.background-image]="'url(' + (slot.item.posterPath ? TMDB_IMAGE_BASE_URL_300 + slot.item.posterPath : 'assets/images/poster-not-found.png') + ')'">
                                        </div>
                                        <div class="ranked-info">
                                            <h4 class="ranked-title">{{ slot.item.title }}</h4>
                                            <p class="ranked-meta">{{ slot.item.releaseDate | date:'yyyy' }}</p>
                                        </div>
                                        <button mat-icon-button class="remove-button" (click)="removeFromRanking(i)">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                } @else {
                                    <!-- Empty State -->
                                    <div class="empty-slot" cdkDrag>
                                        <mat-icon class="empty-icon">add_circle</mat-icon>
                                        <p class="empty-text">Drag your #{{ slot.rank }} choice here</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Action Footer -->
                    <div class="action-footer">
                        @if (isRankingComplete()) {
                            <button mat-raised-button color="primary" class="submit-button" (click)="submitVotes()">
                                <mat-icon>how_to_vote</mat-icon>
                                Cast My Ballots
                            </button>
                        } @else {
                            <button mat-button class="submit-button disabled" disabled>
                                <mat-icon>lock_clock</mat-icon>
                                Complete Ranking to Submit
                            </button>
                            <p class="footer-hint">
                                {{ requiredSlots - rankedItems.length }} more selection{{ (requiredSlots - rankedItems.length) !== 1 ? 's' : '' }} needed
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Waiting State (After Submission) -->
        @if (hasSubmitted) {
            <div class="waiting-overlay" [@celebrateAnimation]>
                <div class="waiting-card glass-panel">
                    <div class="waiting-animation">
                        <mat-icon class="popcorn-icon">local_movies</mat-icon>
                    </div>
                    <h2 class="waiting-title">Votes Submitted!</h2>
                    <p class="waiting-text">Waiting for other members to finish voting...</p>
                    <div class="waiting-progress">
                        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                    </div>
                </div>
            </div>
        }
    </div>
} @else {
    <div class="empty-state">
        <mat-icon class="empty-icon">movie_filter</mat-icon>
        <h2>No Media Available</h2>
        <p>There are no items to choose from in your collection.</p>
        <button mat-raised-button color="primary" routerLink="/group/overview">
            Return to Groups
        </button>
    </div>
}