@if (isLoading) {
    <div class="empty-state">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>Loading media...</p>
    </div>
} @else if (mediaItems.length !== 0) {
    <div class="voting-container" [@fadeAnimation]>
        <!-- Page Heading -->
        <div class="voting-header">
            <div class="header-content">
                <h1 class="header-title">
                    Rank Your <span class="highlight">Shortlist</span>
                </h1>
                <p class="header-subtitle">
                    Drag movies from the shortlist into your top 3 slots. The group's combined ranking will decide what we watch!
                </p>
            </div>
            <div class="selections-indicator">
                <span class="selections-label">Selections</span>
                <span class="selections-count">{{ rankedItems.length }}<span class="selections-total">/{{ requiredSlots }}</span></span>
            </div>
        </div>

        <!-- Main Interactive Area -->
        <div class="voting-grid">
            <!-- Left Column: The Shortlist (Source) -->
            <div class="shortlist-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <mat-icon>list_alt</mat-icon>
                        The Shortlist
                    </h3>
                    <div class="view-toggle">
                        <button mat-icon-button class="view-button">
                            <mat-icon>grid_view</mat-icon>
                        </button>
                        <button mat-icon-button class="view-button">
                            <mat-icon>view_list</mat-icon>
                        </button>
                    </div>
                </div>

                <!-- Movie Grid -->
                <div class="movie-grid" cdkDropList 
                     [id]="shortlistDropListId"
                     [cdkDropListData]="availableItems"
                     [cdkDropListConnectedTo]="slotDropListIds"
                     (cdkDropListDropped)="onDropToShortlist($event)">
                    @for (item of availableItems; track item.tmdbId) {
                        <app-media-card
                            cdkDrag
                            [cdkDragDisabled]="isMobile"
                            [cdkDragData]="{ item: item, slotIndex: -1 }"
                            (cdkDragStarted)="onDragStarted(item, -1)"
                            (cdkDragEnded)="onDragEnded()"
                            [item]="item"
                            [imageBaseUrl300]="TMDB_IMAGE_BASE_URL_300"
                            [isMobile]="isMobile"
                            [showAssignRankButton]="showAssignRankButton"
                            (assignRank)="openRankSelector($event)">
                        </app-media-card>
                    }
                </div>
            </div>

            <!-- Right Column: Ranking Slots (Target) -->
            <div class="ranking-section">
                <div class="ranking-panel glass-panel">
                    <div class="ranking-header">
                        <h3 class="ranking-title">
                            <mat-icon class="trophy-icon">emoji_events</mat-icon>
                            Your Top Picks
                        </h3>
                        <span class="slots-badge">{{ requiredSlots }} slots required</span>
                    </div>

                    <div class="ranking-slots">
                        @for (slot of rankingSlots; track slot.rank; let i = $index) {
                            <div class="ranking-slot" 
                                 cdkDropList
                                 [id]="'slot-' + i"
                                 [cdkDropListData]="{slot: slot, index: i}"
                                 [cdkDropListConnectedTo]="getOtherSlotIds(i)"
                                 (cdkDropListDropped)="onDropToSlot($event, i)"
                                 [class.filled]="slot.item" 
                                 [class.rank-one]="slot.rank === 1">
                                <div class="rank-number">{{ slot.rank }}</div>



                                @if (slot.item) {
                                    <!-- Filled State -->
                                    <div class="ranked-card" cdkDrag [cdkDragDisabled]="isMobile" [cdkDragData]="{item: slot.item, slotIndex: i}" (cdkDragStarted)="onDragStarted(slot.item, i)" (cdkDragEnded)="onDragEnded()">
                                        <!-- Full-card preview on desktop when ranking is complete, otherwise compact poster preview -->
                                        @if (!isMobile && isRankingComplete()) {
                                            <div class="drag-preview-full" *cdkDragPreview>
                                                <div class="ranked-poster" 
                                                     [style.background-image]="'url(' + (slot.item.posterPath ? TMDB_IMAGE_BASE_URL_300 + slot.item.posterPath : 'assets/images/poster-not-found.png') + ')'">
                                                </div>
                                                <div class="ranked-info">
                                                    <h4 class="ranked-title">{{ slot.item.title }}</h4>
                                                    <p class="ranked-meta">{{ slot.item.releaseDate | date:'yyyy' }}</p>
                                                </div>
                                            </div>
                                        } @else {
                                            <div class="drag-preview-poster" *cdkDragPreview
                                                 [style.background-image]="'url(' + (slot.item.posterPath ? TMDB_IMAGE_BASE_URL_300 + slot.item.posterPath : 'assets/images/poster-not-found.png') + ')'">
                                            </div>
                                        }

                                        @if (!isMobile) {
                                            <div class="drag-handle" cdkDragHandle>
                                                <mat-icon>drag_indicator</mat-icon>
                                            </div>
                                        }

                                        <div class="ranked-poster" 
                                             [style.background-image]="'url(' + (slot.item.posterPath ? TMDB_IMAGE_BASE_URL_300 + slot.item.posterPath : 'assets/images/poster-not-found.png') + ')'">
                                        </div>
                                        <div class="ranked-info">
                                            <h4 class="ranked-title">{{ slot.item.title }}</h4>
                                            <p class="ranked-meta">{{ slot.item.releaseDate | date:'yyyy' }}</p>
                                        </div>
                                        <!-- Reorder Buttons (also available on desktop) -->
                                            <div class="mobile-reorder-buttons reorder-buttons-desktop">
                                                <button mat-icon-button class="reorder-button" 
                                                        [disabled]="i === 0 || !slot.item"
                                                        (click)="moveUp(i)"
                                                        aria-label="Move up">
                                                    <mat-icon>arrow_upward</mat-icon>
                                                </button>
                                                <button mat-icon-button class="reorder-button" 
                                                        [disabled]="i === rankingSlots.length - 1 || !slot.item"
                                                        (click)="moveDown(i)"
                                                        aria-label="Move down">
                                                    <mat-icon>arrow_downward</mat-icon>
                                                </button>
                                            </div>
                                        <button mat-icon-button class="remove-button" (click)="removeFromRanking(i)">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                } @else {
                                    <!-- Empty State -->
                                    <div class="empty-slot">
                                        <mat-icon class="empty-icon">add_circle</mat-icon>
                                        <p class="empty-text">{{ isMobile ? 'Tap a movie to assign' : 'Drag your #' + slot.rank + ' choice here' }}</p>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    <!-- Action Footer -->
                    <div class="action-footer">
                        @if (isRankingComplete()) {
                            <button mat-raised-button color="primary" class="submit-button" (click)="submitVotes()">
                                <mat-icon>how_to_vote</mat-icon>
                                Cast My Ballots
                            </button>
                        } @else {
                            <button mat-button class="submit-button disabled" disabled>
                                <mat-icon>lock_clock</mat-icon>
                                Complete Ranking to Submit
                            </button>
                            <p class="footer-hint">
                                {{ requiredSlots - rankedItems.length }} more selection{{ (requiredSlots - rankedItems.length) !== 1 ? 's' : '' }} needed
                            </p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Waiting State (After Submission) -->
        @if (hasSubmitted) {
            <div class="waiting-overlay" [@celebrateAnimation]>
                <div class="waiting-card glass-panel">
                    <div class="waiting-animation">
                        <mat-icon class="popcorn-icon">local_movies</mat-icon>
                    </div>
                    <h2 class="waiting-title">Votes Submitted!</h2>
                    <p class="waiting-text">Waiting for other members to finish voting...</p>
                    <div class="waiting-progress">
                        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
                    </div>
                </div>
            </div>
        }
    </div>
} @else {
    <div class="empty-state">
        <mat-icon class="empty-icon">movie_filter</mat-icon>
        <h2>No Media Available</h2>
        <p>There are no items to choose from in your collection.</p>
        <button mat-raised-button color="primary" routerLink="/group/overview">
            Return to Groups
        </button>
    </div>
}